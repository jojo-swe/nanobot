<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>pocketbot</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#020617" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            colors: {
              pocket: {
                50: "#f0f9ff", 100: "#e0f2fe", 200: "#bae6fd", 300: "#7dd3fc",
                400: "#38bdf8", 500: "#0ea5e9", 600: "#0284c7", 700: "#0369a1",
                800: "#075985", 900: "#0c4a6e", 950: "#082f49",
              },
            },
          },
        },
      };
    </script>
    <style>
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }

      .msg-content p { margin-bottom: 0.5rem; }
      .msg-content p:last-child { margin-bottom: 0; }
      .msg-content pre { background: #1e293b; border-radius: 0.5rem; padding: 1rem; overflow-x: auto; margin: 0.5rem 0; border: 1px solid #334155; position: relative; }
      .msg-content code { font-family: "JetBrains Mono", monospace; font-size: 0.85em; }
      .msg-content :not(pre) > code { background: #1e293b; padding: 0.15rem 0.35rem; border-radius: 0.25rem; color: #e2e8f0; }
      .msg-content ul, .msg-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
      .msg-content ul { list-style-type: disc; }
      .msg-content ol { list-style-type: decimal; }
      .msg-content li { margin-bottom: 0.25rem; }
      .msg-content a { color: #38bdf8; text-decoration: underline; }
      .msg-content blockquote { border-left: 3px solid #475569; padding-left: 1rem; color: #94a3b8; margin: 0.5rem 0; }
      .msg-content h1, .msg-content h2, .msg-content h3 { font-weight: 600; margin: 0.75rem 0 0.25rem; }
      .msg-content h1 { font-size: 1.25rem; }
      .msg-content h2 { font-size: 1.125rem; }
      .msg-content h3 { font-size: 1rem; }
      .msg-content table { border-collapse: collapse; margin: 0.5rem 0; width: 100%; }
      .msg-content th, .msg-content td { border: 1px solid #334155; padding: 0.4rem 0.75rem; text-align: left; }
      .msg-content th { background: #1e293b; font-weight: 600; }

      .typing-dot { animation: typingDot 1.4s infinite both; }
      .typing-dot:nth-child(2) { animation-delay: 0.2s; }
      .typing-dot:nth-child(3) { animation-delay: 0.4s; }
      @keyframes typingDot {
        0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
        30% { opacity: 1; transform: translateY(-4px); }
      }

      .fade-in { animation: fadeIn 0.25s ease-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .slide-down { animation: slideDown 0.2s ease-out; }
      @keyframes slideDown {
        from { opacity: 0; max-height: 0; }
        to { opacity: 1; max-height: 600px; }
      }

      #chatInput { max-height: 200px; }

      /* Attachment preview strip */
      .attach-thumb { position: relative; display: inline-block; }
      .attach-thumb img { width: 56px; height: 56px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #334155; }
      .attach-thumb .remove-btn { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; color: white; line-height: 1; }
      .msg-image { max-width: 280px; max-height: 220px; border-radius: 0.75rem; border: 1px solid #334155; cursor: pointer; margin-top: 0.25rem; display: block; }
      .msg-file { display: inline-flex; align-items: center; gap: 0.5rem; background: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; padding: 0.4rem 0.75rem; font-size: 0.8rem; color: #94a3b8; text-decoration: none; margin-top: 0.25rem; }

      /* Panel tab styling */
      .panel-tab { transition: all 0.15s; }
      .panel-tab.active { color: #e2e8f0; border-bottom-color: #0ea5e9; }

      /* Toast notification */
      .toast {
        animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
      }
      @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

      /* Settings input styling */
      .setting-input {
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 0.375rem 0.625rem;
        font-size: 0.8125rem;
        color: #e2e8f0;
        width: 100%;
        transition: border-color 0.15s;
      }
      .setting-input:focus { outline: none; border-color: #0ea5e9; }
      .setting-input.changed { border-color: #f59e0b; }
    </style>
  </head>
  <body class="h-full bg-slate-950 text-slate-200 font-sans">
    <div id="app" class="h-full flex flex-col">
      <!-- Header -->
      <header class="flex-shrink-0 border-b border-slate-800 bg-slate-950/80 backdrop-blur-sm">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-2.5">
            <span class="text-xl">ðŸ¤–</span>
            <h1 class="text-lg font-semibold text-white">pocketbot</h1>
            <span id="statusBadge" class="text-xs px-2 py-0.5 rounded-full bg-slate-800 text-slate-400">connecting...</span>
          </div>
          <div class="flex items-center gap-1">
            <button onclick="showPanel('status')" title="Status" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            </button>
            <button onclick="showPanel('settings')" title="Settings" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
            <button onclick="showPairModal()" title="Pair mobile app" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </button>
            <button onclick="newSession()" title="New chat" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Panels (status / settings) -->
      <div id="panelContainer" class="hidden border-b border-slate-800 bg-slate-900/60 backdrop-blur-sm slide-down">
        <div class="max-w-4xl mx-auto px-4">

          <!-- Status Panel -->
          <div id="statusPanel" class="hidden py-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-slate-300">Status & Diagnostics</h3>
              <div class="flex gap-2">
                <button onclick="refreshStatus()" class="text-xs px-2.5 py-1 rounded-md bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">Refresh</button>
                <button onclick="pingServer()" class="text-xs px-2.5 py-1 rounded-md bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">Ping</button>
                <button onclick="hidePanel()" class="text-xs px-2.5 py-1 rounded-md text-slate-500 hover:text-white transition-colors">&times;</button>
              </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 text-sm">
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Server</span>
                <p id="stServer" class="text-emerald-400 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Version</span>
                <p id="stVersion" class="text-slate-300 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Uptime</span>
                <p id="stUptime" class="text-slate-300 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Connections</span>
                <p id="stConns" class="text-slate-300 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Model</span>
                <p id="stModel" class="text-pocket-400 mt-0.5 font-mono text-xs truncate">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Provider</span>
                <p id="stProvider" class="text-slate-300 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Auth</span>
                <p id="stAuth" class="mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/50 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Ping</span>
                <p id="stPing" class="text-slate-300 mt-0.5 font-mono text-xs">â€”</p>
              </div>
            </div>
          </div>

          <!-- Settings Panel -->
          <div id="settingsPanel" class="hidden py-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-slate-300">Settings</h3>
              <div class="flex gap-2">
                <button onclick="saveSettings()" id="saveBtn" class="hidden text-xs px-3 py-1 rounded-md bg-pocket-600 text-white hover:bg-pocket-500 transition-colors font-medium">Save Changes</button>
                <button onclick="resetSettings()" id="resetBtn" class="hidden text-xs px-2.5 py-1 rounded-md bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">Reset</button>
                <button onclick="hidePanel()" class="text-xs px-2.5 py-1 rounded-md text-slate-500 hover:text-white transition-colors">&times;</button>
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div>
                <label class="text-slate-500 text-xs uppercase tracking-wider block mb-1">Model</label>
                <input id="cfgModel" type="text" class="setting-input font-mono" data-field="model" />
              </div>
              <div>
                <label class="text-slate-500 text-xs uppercase tracking-wider block mb-1">Max Tokens</label>
                <input id="cfgTokens" type="number" min="1" step="1" class="setting-input font-mono" data-field="max_tokens" />
              </div>
              <div>
                <label class="text-slate-500 text-xs uppercase tracking-wider block mb-1">Temperature</label>
                <input id="cfgTemp" type="number" min="0" max="2" step="0.05" class="setting-input font-mono" data-field="temperature" />
              </div>
              <div>
                <label class="text-slate-500 text-xs uppercase tracking-wider block mb-1">Memory Window</label>
                <input id="cfgMemory" type="number" min="1" step="1" class="setting-input font-mono" data-field="memory_window" />
              </div>
            </div>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="bg-slate-800/30 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Workspace</span>
                <p id="cfgWorkspace" class="text-slate-400 mt-0.5 font-mono text-xs truncate">â€”</p>
              </div>
              <div class="bg-slate-800/30 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Max Iterations</span>
                <p id="cfgIter" class="text-slate-400 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/30 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Web Host</span>
                <p id="cfgHost" class="text-slate-400 mt-0.5 font-mono text-xs">â€”</p>
              </div>
              <div class="bg-slate-800/30 rounded-lg p-2.5">
                <span class="text-slate-500 text-xs uppercase tracking-wider block">Auth</span>
                <p id="cfgAuth" class="mt-0.5 font-mono text-xs">â€”</p>
              </div>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <button onclick="rotateToken()" id="rotateTokenBtn" class="text-xs px-3 py-1.5 rounded-md bg-amber-900/40 text-amber-400 border border-amber-700/40 hover:bg-amber-900/60 transition-colors">ðŸ”‘ Rotate Auth Token</button>
              <span id="rotateTokenMsg" class="text-xs text-slate-500 hidden"></span>
            </div>
            <p id="settingsMsg" class="hidden mt-2 text-xs"></p>
          </div>

        </div>
      </div>

      <!-- Messages area -->
      <main id="messages" class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-4 py-6 space-y-1">
          <div id="welcome" class="flex flex-col items-center justify-center py-20 text-center">
            <span class="text-5xl mb-4">ðŸ¤–</span>
            <h2 class="text-2xl font-semibold text-white mb-2">Welcome to pocketbot</h2>
            <p class="text-slate-400 max-w-md">Your pocket-sized personal AI assistant. Type a message below to get started.</p>
            <div class="mt-6 flex flex-wrap gap-2 justify-center">
              <button onclick="sendQuickMessage('What can you do?')" class="px-3 py-1.5 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">What can you do?</button>
              <button onclick="sendQuickMessage('Tell me about yourself')" class="px-3 py-1.5 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Tell me about yourself</button>
              <button onclick="sendQuickMessage('Help me write some code')" class="px-3 py-1.5 text-sm rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-colors">Help me write code</button>
            </div>
          </div>
        </div>
      </main>

      <!-- Typing indicator -->
      <div id="typingIndicator" class="hidden max-w-4xl mx-auto px-4 pb-2">
        <div class="flex items-center gap-2 text-slate-500 text-sm">
          <span class="text-base">ðŸ¤–</span>
          <div class="flex gap-1">
            <span class="typing-dot w-1.5 h-1.5 rounded-full bg-slate-500"></span>
            <span class="typing-dot w-1.5 h-1.5 rounded-full bg-slate-500"></span>
            <span class="typing-dot w-1.5 h-1.5 rounded-full bg-slate-500"></span>
          </div>
          <span class="text-xs">thinking...</span>
        </div>
      </div>

      <!-- Input area -->
      <footer class="flex-shrink-0 border-t border-slate-800 bg-slate-950/80 backdrop-blur-sm">
        <div class="max-w-4xl mx-auto px-4 py-3">
          <!-- Attachment preview strip -->
          <div id="attachPreview" class="hidden flex gap-2 flex-wrap mb-2"></div>
          <!-- Hidden file input -->
          <input type="file" id="fileInput" accept="image/*,.pdf,.txt" class="hidden" multiple />
          <form id="chatForm" onsubmit="handleSubmit(event)" class="flex items-end gap-2">
            <button type="button" id="attachBtn" title="Attach file" aria-label="Attach file" onclick="document.getElementById('fileInput').click()" class="flex-shrink-0 p-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
            </button>
            <div class="flex-1 relative">
              <textarea id="chatInput" rows="1" placeholder="Type your message... (Shift+Enter for new line)" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-pocket-500 focus:ring-1 focus:ring-pocket-500 resize-none transition-colors"></textarea>
            </div>
            <button type="submit" id="sendBtn" title="Send message" aria-label="Send message" class="flex-shrink-0 p-3 rounded-xl bg-pocket-600 text-white hover:bg-pocket-500 disabled:opacity-40 disabled:cursor-not-allowed transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
          </form>
          <p class="text-center text-xs text-slate-600 mt-2">pocketbot &middot; WebSocket &middot; <span id="attachCount" class="hidden"><span id="attachCountNum">0</span> file(s) attached</span></p>
        </div>
      </footer>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2 items-center"></div>

    <!-- Pair modal -->
    <div id="pairModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm" onclick="hidePairModal()">
      <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-xs w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base font-semibold text-white">Pair Mobile App</h2>
          <button onclick="hidePairModal()" class="text-slate-400 hover:text-white transition-colors">&times;</button>
        </div>
        <p class="text-xs text-slate-400 mb-4">Scan this QR code with the pocketbot app to connect automatically.</p>
        <div id="pairQr" class="flex justify-center mb-4">
          <canvas id="pairQrCanvas"></canvas>
        </div>
        <div id="pairUrl" class="text-center text-xs text-slate-500 font-mono break-all"></div>
        <div id="pairError" class="hidden text-center text-xs text-red-400 mt-2"></div>
        <button onclick="hidePairModal()" class="mt-4 w-full py-2 rounded-xl bg-slate-800 text-slate-300 hover:bg-slate-700 text-sm transition-colors">Close</button>
      </div>
    </div>

    <script>
      // =========================================================================
      // State
      // =========================================================================
      let ws = null;
      let sessionId = null;
      let messageCount = 0;
      let reconnectAttempts = 0;
      const MAX_RECONNECT = 10;
      const RECONNECT_BASE_MS = 1000;

      // Settings state: original values from server
      let originalConfig = {};
      let activePanel = null; // 'status' | 'settings' | null

      // Pending attachments: [{file, localUrl, serverUrl, contentType}]
      let pendingAttachments = [];

      // =========================================================================
      // DOM refs
      // =========================================================================
      const messagesEl = document.getElementById("messages");
      const messagesContainer = messagesEl.querySelector(".space-y-1");
      const welcomeEl = document.getElementById("welcome");
      const typingEl = document.getElementById("typingIndicator");
      const inputEl = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusBadge = document.getElementById("statusBadge");
      const panelContainer = document.getElementById("panelContainer");
      const fileInput = document.getElementById("fileInput");
      const attachPreview = document.getElementById("attachPreview");
      const attachCount = document.getElementById("attachCount");
      const attachCountNum = document.getElementById("attachCountNum");

      // =========================================================================
      // Markdown setup
      // =========================================================================
      marked.setOptions({
        highlight: function (code, lang) {
          if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
          return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
      });

      // =========================================================================
      // Toast notifications
      // =========================================================================
      function showToast(message, type = "info") {
        const colors = {
          success: "bg-emerald-900/90 text-emerald-300 border-emerald-700",
          error: "bg-red-900/90 text-red-300 border-red-700",
          info: "bg-slate-800/90 text-slate-300 border-slate-600",
          warning: "bg-amber-900/90 text-amber-300 border-amber-700",
        };
        const el = document.createElement("div");
        el.className = `toast text-xs px-4 py-2 rounded-lg border backdrop-blur-sm ${colors[type] || colors.info}`;
        el.textContent = message;
        document.getElementById("toastContainer").appendChild(el);
        setTimeout(() => el.remove(), 3000);
      }

      // =========================================================================
      // Panel management
      // =========================================================================
      function showPanel(name) {
        if (activePanel === name) { hidePanel(); return; }
        activePanel = name;
        panelContainer.classList.remove("hidden");
        document.getElementById("statusPanel").classList.toggle("hidden", name !== "status");
        document.getElementById("settingsPanel").classList.toggle("hidden", name !== "settings");
        if (name === "status") refreshStatus();
        if (name === "settings") loadConfig();
      }

      function hidePanel() {
        activePanel = null;
        panelContainer.classList.add("hidden");
      }

      // =========================================================================
      // Status panel
      // =========================================================================
      async function refreshStatus() {
        try {
          const res = await fetch("/api/status");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const d = await res.json();
          document.getElementById("stServer").textContent = d.status || "unknown";
          document.getElementById("stServer").className = `mt-0.5 font-mono text-xs ${d.status === "running" ? "text-emerald-400" : "text-red-400"}`;
          document.getElementById("stVersion").textContent = d.version || "â€”";
          document.getElementById("stUptime").textContent = formatUptime(d.uptime_seconds);
          document.getElementById("stConns").textContent = d.connections ?? "â€”";
          document.getElementById("stModel").textContent = d.model || "â€”";
          document.getElementById("stProvider").textContent = d.provider || "â€”";
          const authEl = document.getElementById("stAuth");
          authEl.textContent = d.auth_enabled ? "enabled" : "disabled";
          authEl.className = `mt-0.5 font-mono text-xs ${d.auth_enabled ? "text-emerald-400" : "text-amber-400"}`;
        } catch (e) {
          document.getElementById("stServer").textContent = "unreachable";
          document.getElementById("stServer").className = "mt-0.5 font-mono text-xs text-red-400";
          showToast("Failed to fetch status", "error");
        }
      }

      async function pingServer() {
        const stPing = document.getElementById("stPing");
        stPing.textContent = "...";
        try {
          const t0 = performance.now();
          const res = await fetch("/api/ping", { method: "POST" });
          const ms = Math.round(performance.now() - t0);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          stPing.textContent = `${ms}ms`;
          stPing.className = `mt-0.5 font-mono text-xs ${ms < 100 ? "text-emerald-400" : ms < 500 ? "text-amber-400" : "text-red-400"}`;
        } catch {
          stPing.textContent = "failed";
          stPing.className = "mt-0.5 font-mono text-xs text-red-400";
        }
      }

      // =========================================================================
      // Pair modal (QR code)
      // =========================================================================
      async function showPairModal() {
        document.getElementById("pairModal").classList.remove("hidden");
        document.getElementById("pairError").classList.add("hidden");
        document.getElementById("pairUrl").textContent = "";
        const canvas = document.getElementById("pairQrCanvas");
        // Clear previous
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        try {
          const res = await fetch("/api/pair");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          const payload = JSON.stringify(data);
          await QRCode.toCanvas(canvas, payload, {
            width: 220,
            margin: 1,
            color: { dark: "#e2e8f0", light: "#0f172a" },
          });
          document.getElementById("pairUrl").textContent = data.url;
        } catch (e) {
          const errEl = document.getElementById("pairError");
          errEl.textContent = `Failed to load pairing data: ${e.message}`;
          errEl.classList.remove("hidden");
        }
      }

      function hidePairModal() {
        document.getElementById("pairModal").classList.add("hidden");
      }

      function formatUptime(seconds) {
        if (!seconds && seconds !== 0) return "â€”";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0) return `${h}h ${m}m`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
      }

      // =========================================================================
      // Settings panel
      // =========================================================================
      async function loadConfig() {
        try {
          const res = await fetch("/api/config");
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const d = await res.json();
          originalConfig = { model: d.model, max_tokens: d.max_tokens, temperature: d.temperature, memory_window: d.memory_window };

          document.getElementById("cfgModel").value = d.model || "";
          document.getElementById("cfgTokens").value = d.max_tokens || "";
          document.getElementById("cfgTemp").value = d.temperature ?? "";
          document.getElementById("cfgMemory").value = d.memory_window || "";
          document.getElementById("cfgWorkspace").textContent = d.workspace || "â€”";
          document.getElementById("cfgIter").textContent = d.max_tool_iterations ?? "â€”";
          document.getElementById("cfgHost").textContent = `${d.web_host || "?"}:${d.web_port || "?"}`;
          const authEl = document.getElementById("cfgAuth");
          authEl.textContent = d.auth_enabled ? "enabled" : "disabled";
          authEl.className = `mt-0.5 font-mono text-xs ${d.auth_enabled ? "text-emerald-400" : "text-amber-400"}`;

          checkSettingsChanged();
        } catch {
          showToast("Failed to load config", "error");
        }
      }

      function checkSettingsChanged() {
        const fields = document.querySelectorAll(".setting-input");
        let changed = false;
        fields.forEach(f => {
          const key = f.dataset.field;
          const orig = String(originalConfig[key] ?? "");
          const isChanged = f.value !== orig;
          f.classList.toggle("changed", isChanged);
          if (isChanged) changed = true;
        });
        document.getElementById("saveBtn").classList.toggle("hidden", !changed);
        document.getElementById("resetBtn").classList.toggle("hidden", !changed);
      }

      async function saveSettings() {
        const body = {};
        document.querySelectorAll(".setting-input").forEach(f => {
          const key = f.dataset.field;
          const orig = String(originalConfig[key] ?? "");
          if (f.value !== orig) {
            body[key] = f.type === "number" ? parseFloat(f.value) : f.value;
          }
        });

        if (Object.keys(body).length === 0) return;

        try {
          const res = await fetch("/api/config", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const result = await res.json();

          if (result.errors && Object.keys(result.errors).length > 0) {
            const errMsg = Object.entries(result.errors).map(([k, v]) => `${k}: ${v}`).join(", ");
            showToast(`Errors: ${errMsg}`, "error");
          }
          if (result.updated && Object.keys(result.updated).length > 0) {
            showToast(`Saved: ${Object.keys(result.updated).join(", ")}`, "success");
            // Reload to get fresh values
            await loadConfig();
          }
        } catch (e) {
          showToast(`Save failed: ${e.message}`, "error");
        }
      }

      async function rotateToken() {
        const btn = document.getElementById("rotateTokenBtn");
        const msg = document.getElementById("rotateTokenMsg");
        btn.disabled = true;
        btn.textContent = "Rotatingâ€¦";
        msg.classList.add("hidden");
        try {
          const res = await fetch("/api/auth/rotate", { method: "POST" });
          if (!res.ok) {
            const d = await res.json().catch(() => ({}));
            throw new Error(d.detail || `HTTP ${res.status}`);
          }
          const data = await res.json();
          msg.textContent = `New token: ${data.token}`;
          msg.className = "text-xs text-emerald-400 font-mono break-all";
          msg.classList.remove("hidden");
          showToast("Token rotated â€” update your app!", "warning");
        } catch (e) {
          msg.textContent = `Failed: ${e.message}`;
          msg.className = "text-xs text-red-400";
          msg.classList.remove("hidden");
        } finally {
          btn.disabled = false;
          btn.textContent = "ðŸ”‘ Rotate Auth Token";
        }
      }

      function resetSettings() {
        document.getElementById("cfgModel").value = originalConfig.model || "";
        document.getElementById("cfgTokens").value = originalConfig.max_tokens || "";
        document.getElementById("cfgTemp").value = originalConfig.temperature ?? "";
        document.getElementById("cfgMemory").value = originalConfig.memory_window || "";
        checkSettingsChanged();
      }

      // Attach change listeners to setting inputs
      document.querySelectorAll(".setting-input").forEach(f => {
        f.addEventListener("input", checkSettingsChanged);
      });

      // =========================================================================
      // WebSocket connection
      // =========================================================================
      function connect() {
        const proto = location.protocol === "https:" ? "wss:" : "ws:";
        const url = `${proto}//${location.host}/ws/chat`;
        ws = new WebSocket(url);

        ws.onopen = () => {
          reconnectAttempts = 0;
          setStatus("connected", "bg-emerald-900/50 text-emerald-400");
        };
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          handleServerMessage(data);
        };
        ws.onclose = (e) => {
          if (e.code === 4001) {
            setStatus("unauthorized", "bg-red-900/50 text-red-400");
            showToast("Authentication required. Enable auth token in config.", "error");
            return;
          }
          setStatus("disconnected", "bg-red-900/50 text-red-400");
          scheduleReconnect();
        };
        ws.onerror = () => {
          setStatus("error", "bg-red-900/50 text-red-400");
        };
      }

      function scheduleReconnect() {
        if (reconnectAttempts >= MAX_RECONNECT) {
          setStatus("failed", "bg-red-900/50 text-red-400");
          return;
        }
        reconnectAttempts++;
        const delay = RECONNECT_BASE_MS * Math.pow(2, Math.min(reconnectAttempts - 1, 5));
        setStatus(`reconnecting (${reconnectAttempts})...`, "bg-yellow-900/50 text-yellow-400");
        setTimeout(connect, delay);
      }

      function setStatus(text, classes) {
        statusBadge.textContent = text;
        statusBadge.className = `text-xs px-2 py-0.5 rounded-full ${classes}`;
      }

      // =========================================================================
      // Server message handling
      // =========================================================================
      function handleServerMessage(data) {
        switch (data.type) {
          case "connected":
            sessionId = data.session_id;
            break;
          case "message":
            hideTyping();
            addMessage(data.role || "assistant", data.content);
            break;
          case "typing":
            if (data.status) showTyping(); else hideTyping();
            break;
          case "error":
            hideTyping();
            addMessage("error", data.content);
            break;
          case "pong":
            break;
        }
      }

      // =========================================================================
      // Chat logic
      // =========================================================================
      function handleSubmit(e) {
        e.preventDefault();
        const content = inputEl.value.trim();
        const hasAttachments = pendingAttachments.length > 0;
        if ((!content && !hasAttachments) || !ws || ws.readyState !== WebSocket.OPEN) return;
        sendMessage(content, [...pendingAttachments]);
        clearAttachments();
      }

      function sendMessage(content, attachments = []) {
        if (messageCount === 0 && welcomeEl) welcomeEl.style.display = "none";
        addMessage("user", content, attachments);
        // Build message with attachment URLs appended as markdown
        let fullContent = content;
        if (attachments.length > 0) {
          const links = attachments.map(a => {
            if (a.contentType.startsWith("image/")) return `![image](${a.serverUrl})`;
            return `[${a.file.name}](${a.serverUrl})`;
          }).join("\n");
          fullContent = content ? `${content}\n${links}` : links;
        }
        ws.send(JSON.stringify({ type: "message", content: fullContent }));
        inputEl.value = "";
        inputEl.style.height = "auto";
        inputEl.focus();
      }

      // =========================================================================
      // Attachment handling
      // =========================================================================
      fileInput.addEventListener("change", async () => {
        const files = Array.from(fileInput.files || []);
        fileInput.value = "";
        for (const file of files) {
          await addAttachment(file);
        }
      });

      async function addAttachment(file) {
        const localUrl = URL.createObjectURL(file);
        const isImage = file.type.startsWith("image/");

        // Show preview immediately
        const thumb = document.createElement("div");
        thumb.className = "attach-thumb";
        const idx = pendingAttachments.length;
        thumb.dataset.idx = idx;
        if (isImage) {
          thumb.innerHTML = `<img src="${localUrl}" alt="${escapeHtml(file.name)}" /><span class="remove-btn" onclick="removeAttachment(${idx})">âœ•</span>`;
        } else {
          thumb.innerHTML = `<div class="flex items-center gap-1 bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-xs text-slate-300" style="max-width:120px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${escapeHtml(file.name)}</div><span class="remove-btn" onclick="removeAttachment(${idx})">âœ•</span>`;
        }
        attachPreview.appendChild(thumb);
        attachPreview.classList.remove("hidden");

        // Upload to server
        const entry = { file, localUrl, serverUrl: null, contentType: file.type, thumb };
        pendingAttachments.push(entry);
        updateAttachCount();

        try {
          const fd = new FormData();
          fd.append("file", file);
          const res = await fetch("/api/upload", { method: "POST", body: fd });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          entry.serverUrl = data.url;
        } catch (err) {
          showToast(`Upload failed: ${err.message}`, "error");
          removeAttachment(idx);
        }
      }

      function removeAttachment(idx) {
        const entry = pendingAttachments[idx];
        if (!entry) return;
        if (entry.localUrl) URL.revokeObjectURL(entry.localUrl);
        if (entry.thumb) entry.thumb.remove();
        pendingAttachments[idx] = null;
        // Compact
        pendingAttachments = pendingAttachments.filter(Boolean);
        if (pendingAttachments.length === 0) attachPreview.classList.add("hidden");
        updateAttachCount();
      }

      function clearAttachments() {
        pendingAttachments.forEach(a => { if (a?.localUrl) URL.revokeObjectURL(a.localUrl); });
        pendingAttachments = [];
        attachPreview.innerHTML = "";
        attachPreview.classList.add("hidden");
        updateAttachCount();
      }

      function updateAttachCount() {
        const n = pendingAttachments.length;
        if (n === 0) { attachCount.classList.add("hidden"); return; }
        attachCountNum.textContent = n;
        attachCount.classList.remove("hidden");
      }

      function sendQuickMessage(content) {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        sendMessage(content);
      }

      function newSession() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        // Clear messages visually
        messagesContainer.innerHTML = "";
        messageCount = 0;
        if (welcomeEl) welcomeEl.style.display = "";
        messagesContainer.appendChild(welcomeEl);
        showToast("New chat session", "info");
      }

      // =========================================================================
      // Message rendering
      // =========================================================================
      function addMessage(role, content, attachments = []) {
        messageCount++;
        const wrapper = document.createElement("div");
        wrapper.className = "fade-in";

        if (role === "user") {
          // Build attachment HTML for user bubble
          let attachHtml = "";
          attachments.forEach(a => {
            if (!a) return;
            if (a.contentType.startsWith("image/")) {
              attachHtml += `<img src="${a.localUrl}" class="msg-image" onclick="window.open('${a.serverUrl || a.localUrl}','_blank')" />`;
            } else {
              attachHtml += `<a href="${a.serverUrl || a.localUrl}" target="_blank" class="msg-file">ðŸ“Ž ${escapeHtml(a.file.name)}</a>`;
            }
          });
          wrapper.innerHTML = `
          <div class="flex justify-end mb-4">
            <div class="max-w-[85%] md:max-w-[70%]">
              <div class="bg-pocket-600/20 border border-pocket-500/20 rounded-2xl rounded-tr-md px-4 py-2.5">
                ${attachHtml}
                ${content ? `<div class="msg-content text-sm text-slate-200 ${attachHtml ? 'mt-1' : ''}">${escapeHtml(content)}</div>` : ""}
              </div>
              <div class="text-right mt-1 text-xs text-slate-600">${formatTime()}</div>
            </div>
          </div>`;
        } else if (role === "error") {
          wrapper.innerHTML = `
          <div class="flex mb-4">
            <div class="max-w-[85%] md:max-w-[70%]">
              <div class="bg-red-900/20 border border-red-500/20 rounded-2xl rounded-tl-md px-4 py-2.5">
                <div class="msg-content text-sm text-red-300">${escapeHtml(content)}</div>
              </div>
            </div>
          </div>`;
        } else {
          wrapper.innerHTML = `
          <div class="flex mb-4 gap-3">
            <div class="flex-shrink-0 w-7 h-7 rounded-full bg-slate-800 flex items-center justify-center text-sm mt-0.5">ðŸ¤–</div>
            <div class="max-w-[85%] md:max-w-[75%] min-w-0">
              <div class="bg-slate-900/60 border border-slate-800 rounded-2xl rounded-tl-md px-4 py-2.5">
                <div class="msg-content text-sm text-slate-300">${renderMarkdown(content)}</div>
              </div>
              <div class="mt-1 text-xs text-slate-600">${formatTime()}</div>
            </div>
          </div>`;
          wrapper.querySelectorAll("pre code").forEach((block) => hljs.highlightElement(block));
        }

        messagesContainer.appendChild(wrapper);
        scrollToBottom();
      }

      function renderMarkdown(text) {
        if (!text) return "";
        try { return marked.parse(text); } catch { return escapeHtml(text); }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatTime() {
        return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      function scrollToBottom() {
        requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight; });
      }

      // =========================================================================
      // Typing indicator
      // =========================================================================
      function showTyping() { typingEl.classList.remove("hidden"); scrollToBottom(); }
      function hideTyping() { typingEl.classList.add("hidden"); }

      // =========================================================================
      // Input handling
      // =========================================================================
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSubmit(e); }
      });

      // Auto-resize textarea
      inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + "px";
      });

      // Keep-alive ping
      setInterval(() => {
        if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: "ping" }));
      }, 30000);

      // =========================================================================
      // Init
      // =========================================================================
      connect();
      inputEl.focus();
    </script>
  </body>
</html>
